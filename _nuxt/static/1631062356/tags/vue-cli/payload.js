__NUXT_JSONP__("/tags/vue-cli", (function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){return {data:[{term:{slug:"vue-cli",title:m,path:"\u002Ftags\u002Fvue-cli"},articles:[{slug:"tnt-monorepo",description:"Combining the files and histories of three separate Git repositories",title:"Creating a Monorepo for my TNT Packages",authors:["Thom Bruce"],date:"2021-09-04T02:20:17.000Z",categories:["Journal"],series:["My Process"],tags:["Git","Vue.js",m,"NuxtJS","TNT"],toc:[],body:{type:"root",children:[{type:b,tag:e,props:{},children:[{type:a,value:"Recently, I "},{type:b,tag:"nuxt-link",props:{to:"\u002Fseries\u002Freworking-tnt"},children:[{type:a,value:"reworked TNT"}]},{type:a,value:". TNT was a Nuxt module that provided a set of common dependencies and components that I use frequently across my Nuxt projects. Now, it's a Vue plugin that does the same for Vue projects that do not use Nuxt. And it's also a Vue CLI plugin, which just makes installing it a lot easier. In fact, these three things - the Nuxt module, the Vue plugin and the Vue CLI plugin - now live in three separate repositories... but they share a lot of DNA, naturally. Both the Nuxt module and the CLI plugin require TNT as a dependency. And the TNT docs, which live in the main repository, in turn require Nuxt TNT... It's "},{type:b,tag:f,props:{},children:[{type:a,value:l}]},{type:a,value:" a circular dependency. "},{type:b,tag:f,props:{},children:[{type:a,value:"Almost."}]},{type:a,value:" Strictly the docs site is a distinct project from the main TNT one, they just live alongside one another. They didn't have to live together - that's a decision I made so that the TNT docs would live at a nice looking GitHub Pages URL... It was a vanity. But it has other benefits, we're just not yet making full utilisation of them because of the aforementioned "},{type:b,tag:f,props:{},children:[{type:a,value:l}]},{type:a,value:" circular dependency. The docs don't directly depend on the main code, they depend on Nuxt TNT which depends on the main code in turn. So... what if I moved Nuxt TNT (and the CLI plugin) into this same repository? Then I wouldn't have to worry about this project depending on that one, which in turn depends on the first one... The "},{type:b,tag:f,props:{},children:[{type:a,value:l}]},{type:a,value:" circular dependency would instead refer to projects in the same project tree. The "},{type:b,tag:f,props:{},children:[{type:a,value:l}]},{type:a,value:" circle is still there, but it's neatly hidden in a branching directory structure. My code could make use of the latest changes to other projects in the directory tree, common processes could be run from the parent folder of all three, and I should no longer need to worry about bouncing back and forth between projects to "},{type:b,tag:d,props:{},children:[{type:a,value:"yarn upgrade"}]},{type:a,value:" in an "},{type:b,tag:f,props:{},children:[{type:a,value:"ALMOST"}]},{type:a,value:" circular loop to update these dependencies."}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"This is what's known as a "},{type:b,tag:f,props:{},children:[{type:a,value:"monorepo"}]},{type:a,value:", a singular repository housing the source code for multiple projects that share... something in common. What they share in common isn't always as cut-and-dry as my use case; for example, the repository for Ruby on Rails houses the source code for a lot of its own dependencies like Action Pack and Active Record that could, "},{type:b,tag:f,props:{},children:[{type:a,value:"strictly"}]},{type:a,value:" work independently. Vue CLI and Nuxt TNT do not work independently; it's sort of the inverse of the Rails project. Rather than Rails depending on all of these independent parts, TNT has these independent parts which depend on it."}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"The reason that monorepos have surged in popularity, I think, is because it makes development a lot easier. When you have these projects which depend on one another in whatever direction, and you have a team managing the development of all of them, it helps to have that all in one place. That way if an issue is identified with one project, but it's discovered that it originates somewhere else in the stack, it is trivial to address and push the common changes together."}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"There are tradeoffs, of course... One small example pertaining to open source development: someone may want to fork only Nuxt TNT and make a change to one part of that for their own purposes, but now they need to fork a monorepo and... figure out how their project includes a dependency coming from that form of architecture. So monorepos can be unfriendly. It's possible we'll address this a ways down the line by making each subdirectory a Git Submodule... but this is unfriendly in its own sort of way. We just aren't going to worry about that just yet."}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"For the time being, we just want to bring together TNT, Vue CLI TNT and Nuxt TNT in to one repository so that they can share code, share development, share common build tasks. And err..."}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"There's an easy way to do that. We just copy the files and directories from each project into their desired locations in the main project. Easy peasy..."}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"...but we lose each project's respective Git history that way. Preferably we would be... merging the three projects into one, revision history included. So let's figure out how to do that instead, shall we?"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"Ultimately, we want the resultant project to live in the same place that the core TNT library currently does (that's "},{type:b,tag:"a",props:{href:n,rel:["nofollow","noopener","noreferrer"],target:"_blank"},children:[{type:a,value:n}]},{type:a,value:"), and we want it to incorporate that core library as well as Nuxt TNT and Vue CLI Plugin TNT, each in three separate directories."}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"In other words, the base directory - "},{type:b,tag:d,props:{},children:[{type:a,value:"\u002F"}]},{type:a,value:" - is a sort of brand new space housing all three. And the three of them have their own directories - "},{type:b,tag:d,props:{},children:[{type:a,value:o}]},{type:a,value:p},{type:b,tag:d,props:{},children:[{type:a,value:"\u002Fnuxt"}]},{type:a,value:p},{type:b,tag:d,props:{},children:[{type:a,value:"\u002Fcli"}]},{type:a,value:" - somehow having preserved their respective histories from the Git repositories that currently house them..."}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"Sounds... complicated enough."}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"We'll start by creating a clean project to house the three existing ones..."}]},{type:a,value:c},{type:b,tag:g,props:{className:[h]},children:[{type:b,tag:i,props:{className:[j,k]},children:[{type:b,tag:d,props:{},children:[{type:a,value:"mkdir tnt-monorepo\ncd tnt-monorepo\ngit init\ntouch .monorepo\ngit add .\ngit commit -m \"Initial commit\"\n"}]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"We also need something to be committed initially, hence the "},{type:b,tag:d,props:{},children:[{type:a,value:"touch .monorepo"}]},{type:a,value:" command. This creates an empty file for me to commit - it can be anything, but it mustn't have a name conflict with any of the files we'll be merging, so I've just called it "},{type:b,tag:d,props:{},children:[{type:a,value:".monorepo"}]},{type:a,value:"."}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"Now we can do our first project merge..."}]},{type:a,value:c},{type:b,tag:g,props:{className:[h]},children:[{type:b,tag:i,props:{className:[j,k]},children:[{type:b,tag:d,props:{},children:[{type:a,value:"git remote add -f tnt https:\u002F\u002Fgithub.com\u002Fthombruce\u002Ftnt.git\ngit merge -s ours --no-commit tnt\u002Fmain --allow-unrelated-histories\ngit read-tree --prefix=tnt\u002F -u tnt\u002Fmain\ngit commit -m \"Merge TNT Core\"\n"}]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"...and that's the full merge. TNT's history is preserved and now lives in a "},{type:b,tag:d,props:{},children:[{type:a,value:o}]},{type:a,value:" folder in this new Git repository. There's a little to explain here, so we'll go through it step by step."}]},{type:a,value:c},{type:b,tag:g,props:{className:[h]},children:[{type:b,tag:i,props:{className:[j,k]},children:[{type:b,tag:d,props:{},children:[{type:a,value:"git remote add -f tnt https:\u002F\u002Fgithub.com\u002Fthombruce\u002Ftnt.git\n"}]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:b,tag:f,props:{},children:[{type:a,value:"This adds the existing GitHub repository for TNT as a remote repository for this one. A remote is essentially... some other Git repository we want to communicate with; typically it is a remote copy of the one we're actually working on, and it is often called 'origin'. In this case it's another repository entirely. We add the "},{type:b,tag:d,props:{},children:[{type:a,value:"-f"}]},{type:a,value:" flag to tell it to fetch the Git history immediately, but we don't actually make any alterations to the state of our new monorepo at this point."}]}]},{type:a,value:c},{type:b,tag:g,props:{className:[h]},children:[{type:b,tag:i,props:{className:[j,k]},children:[{type:b,tag:d,props:{},children:[{type:a,value:"git merge -s ours --no-commit tnt\u002Fmain --allow-unrelated-histories\n"}]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:b,tag:f,props:{},children:[{type:a,value:"This is the command that actually merges the other repository's main branch. Often "},{type:b,tag:d,props:{},children:[{type:a,value:"merge"}]},{type:a,value:" is used to... merge branches, and this is no different. The "},{type:b,tag:d,props:{},children:[{type:a,value:"-s ours"}]},{type:a,value:" flag tells it to resolve conflicts by favouring the monorepo's files (this is \"our\" project). "},{type:b,tag:d,props:{},children:[{type:a,value:"--no-commit"}]},{type:a,value:" halts the merge process before committing it, because these files are otherwise going to be merged into the root directory. And "},{type:b,tag:d,props:{},children:[{type:a,value:"--allow-unrelated-histories"}]},{type:a,value:" is important to address the fact that our repository and TNT's have very different Git histories; Git typically disallows this merge for our own safety, but we have the option to override that. Next..."}]}]},{type:a,value:c},{type:b,tag:g,props:{className:[h]},children:[{type:b,tag:i,props:{className:[j,k]},children:[{type:b,tag:d,props:{},children:[{type:a,value:"git read-tree --prefix=tnt\u002F -u tnt\u002Fmain\n"}]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:b,tag:f,props:{},children:[{type:a,value:"This command reads the contents of the tree at "},{type:b,tag:d,props:{},children:[{type:a,value:q}]},{type:a,value:", doing so under the given prefix and, with the "},{type:b,tag:d,props:{},children:[{type:a,value:"-u"}]},{type:a,value:" flag, updates the working tree with those contents. In other words... it moves the contents of the origin and branch at "},{type:b,tag:d,props:{},children:[{type:a,value:q}]},{type:a,value:" into our new "},{type:b,tag:d,props:{},children:[{type:a,value:"tnt\u002F"}]},{type:a,value:" directory."}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:b,tag:f,props:{},children:[{type:a,value:"And finally, we complete the merge and give it a commit message:"}]}]},{type:a,value:c},{type:b,tag:g,props:{className:[h]},children:[{type:b,tag:i,props:{className:[j,k]},children:[{type:b,tag:d,props:{},children:[{type:a,value:"git commit -m \"Merge TNT Core\"\n"}]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"Got it? ... Good, because I'm not sure I do. But it works!"}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"Now we just repeat the process for the other two repositories..."}]},{type:a,value:c},{type:b,tag:g,props:{className:[h]},children:[{type:b,tag:i,props:{className:[j,k]},children:[{type:b,tag:d,props:{},children:[{type:a,value:"git remote add -f cli https:\u002F\u002Fgithub.com\u002Fthombruce\u002Fvue-cli-plugin-tnt.git\ngit merge -s ours --no-commit cli\u002Fmain --allow-unrelated-histories\ngit read-tree --prefix=cli\u002F -u cli\u002Fmain\ngit commit -m \"Merge TNT CLI\"\n\ngit remote add -f nuxt https:\u002F\u002Fgithub.com\u002Fthombruce\u002Fnuxt-tnt.git\ngit merge -s ours --no-commit nuxt\u002Fmain --allow-unrelated-histories\ngit read-tree --prefix=nuxt\u002F -u nuxt\u002Fmain\ngit commit -m \"Merge Nuxt TNT\"\n"}]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"...and just like that, we have our full monorepo. Oh, and we can delete that initial file now..."}]},{type:a,value:c},{type:b,tag:g,props:{className:[h]},children:[{type:b,tag:i,props:{className:[j,k]},children:[{type:b,tag:d,props:{},children:[{type:a,value:"git rm .monorepo\ngit commit -m \"Cleanup: Delete .monorepo file\"\n"}]}]}]},{type:a,value:c},{type:b,tag:e,props:{},children:[{type:a,value:"Now my monorepo only houses those three directories and their project files. And I can be confident that the three projects still work independently, since nothing has fundamentally changed here. They'll each need "},{type:b,tag:d,props:{},children:[{type:a,value:"yarn install"}]},{type:a,value:" to be ran, but they'll work. It's a working monorepo, and I believe this will let me better manage development of the whole TNT project going forwards."}]}]},dir:"\u002Fblog",path:"\u002Fblog\u002Ftnt-monorepo",extension:".md",createdAt:r,updatedAt:r}],_img:{}}],fetch:{},mutations:void 0}}("text","element","\n","code","p","em","div","nuxt-content-highlight","pre","language-text","line-numbers","almost","Vue CLI","https:\u002F\u002Fgithub.com\u002Fthombruce\u002Ftnt","\u002Ftnt",", ","tnt\u002Fmain","2021-09-08T00:51:02.507Z")));